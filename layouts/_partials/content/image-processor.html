{{/* 
  通用图片处理器 - 统一的图片资源查找、格式检测和处理逻辑
  
  输入参数：
  - .context: 页面上下文 (必需)
  - .src: 图片源路径 (必需)
  - .alt: 图片alt文本 (可选)
  - .caption: 图片说明 (可选)
  - .enableModal: 是否启用模态框 (可选，默认false)
  - .enableResponsive: 是否启用响应式处理 (可选，默认true)
  - .enablePlaceholder: 是否启用占位图 (可选，默认true)
  - .outputType: 输出类型 ("img", "data", "both") (可选，默认"both")
  
  输出：
  - 设置到context.Scratch的变量：
    - imageResource: 图片资源对象
    - imageUrl: 最终图片URL
    - imageType: 资源类型 ("page", "global", "static", "external")
    - isModernFormat: 是否为现代格式
    - canProcess: 是否可以进行Hugo处理
    - placeholderData: 占位图相关数据
    - processedImages: 响应式图片数据
*/}}

{{- $context := .context -}}
{{- $src := .src -}}
{{- $alt := .alt | default "" -}}
{{- $caption := .caption | default "" -}}
{{- $enableModal := .enableModal | default false -}}
{{- $enableResponsive := .enableResponsive | default true -}}
{{- $enablePlaceholder := .enablePlaceholder | default true -}}
{{- $outputType := .outputType | default "both" -}}

{{/* 响应式尺寸配置 */}}
{{- $respSizes := slice "320" "640" "960" "1280" "1600" "1920" -}}
{{- $hint := "photo" -}}
{{- $filter := "Lanczos" -}}

{{/* 支持的格式配置 */}}
{{- $modernFormats := slice "avif" "heic" "heif" -}}
{{- $processableFormats := slice "jpeg" "jpg" "png" "gif" "tiff" "tif" "bmp" "webp" -}}

{{/* 初始化变量 */}}
{{- $resource := false -}}
{{- $resourceType := "" -}}
{{- $isExternal := false -}}
{{- $isModernFormat := false -}}
{{- $canProcess := false -}}
{{- $finalUrl := "" -}}

{{/* 路径标准化函数 */}}
{{- $normalizedPath := $src -}}
{{- if hasPrefix $src "./" -}}
  {{- $normalizedPath = strings.TrimPrefix "./" $src -}}
{{- else if hasPrefix $src "/" -}}
  {{- $normalizedPath = strings.TrimPrefix "/" $src -}}
{{- end -}}

{{/* 检查是否为外部URL */}}
{{- if or (hasPrefix $src "http://") (hasPrefix $src "https://") -}}
  {{- $isExternal = true -}}
  {{- $resourceType = "external" -}}
  {{- $finalUrl = $src -}}
  
  {{/* 尝试获取远程资源 - 增加缓存机制 */}}
  {{- $cacheKey := printf "remote_resource_%s" (md5 $src) -}}
  {{- $cachedResource := $context.Scratch.Get $cacheKey -}}
  {{- if $cachedResource -}}
    {{- $resource = $cachedResource -}}
    {{- $finalUrl = $cachedResource.RelPermalink -}}
  {{- else -}}
    {{- with try (resources.GetRemote $src) -}}
      {{- with .Err -}}
        {{/* 远程资源获取失败，记录到Scratch以便调试 */}}
        {{- $context.Scratch.SetInMap "imageErrors" $src .Error -}}
      {{- else with .Value -}}
        {{/* 远程资源获取成功，缓存结果 */}}
        {{- $resource = . -}}
        {{- $finalUrl = .RelPermalink -}}
        {{- $context.Scratch.Set $cacheKey . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{/* 本地资源处理 - 优化查找逻辑 */}}
  {{- $searchPaths := slice $src $normalizedPath -}}
  {{- if ne $src $normalizedPath -}}
    {{- $searchPaths = $searchPaths | append $src -}}
  {{- end -}}
  
  {{/* 按优先级查找资源：页面资源 -> 全局资源 -> 静态文件 */}}
  {{- range $path := $searchPaths -}}
    {{- if not $resource -}}
      {{/* 1. 页面资源查找 */}}
      {{- with $context.Resources.GetMatch $path -}}
        {{- $resource = . -}}
        {{- $resourceType = "page" -}}
        {{- $finalUrl = .RelPermalink -}}
        {{- break -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{/* 2. 全局资源查找 */}}
  {{- if not $resource -}}
    {{- range $path := $searchPaths -}}
      {{- if not $resource -}}
        {{- with resources.Get $path -}}
          {{- $resource = . -}}
          {{- $resourceType = "global" -}}
          {{- $finalUrl = .RelPermalink -}}
          {{- break -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{/* 3. 静态文件回退 */}}
  {{- if not $resource -}}
    {{- $resourceType = "static" -}}
    {{- $finalUrl = $src -}}
  {{- end -}}
{{- end -}}

{{/* 检测图像格式和处理能力 - 优化检测逻辑 */}}
{{- if $resource -}}
  {{- $fileExt := lower (path.Ext $resource.Name | strings.TrimPrefix ".") -}}
  {{- $mediaSubType := lower $resource.MediaType.SubType -}}
  
  {{/* 检测现代格式 */}}
  {{- if or (in $modernFormats $mediaSubType) (in $modernFormats $fileExt) -}}
    {{- $isModernFormat = true -}}
  {{- end -}}
  
  {{/* 检测是否可以进行Hugo图像处理 */}}
  {{- if and (not $isModernFormat) (ne $mediaSubType "svg") -}}
    {{- if or (in $processableFormats $mediaSubType) (in $processableFormats $fileExt) -}}
      {{- $canProcess = true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 生成占位图数据 - 优化占位图逻辑 */}}
{{- $placeholderData := dict -}}
{{- if $enablePlaceholder -}}
  {{/* 优化的占位图处理逻辑 */}}
  {{- $randomImage := "" -}}
  {{- $useRandomImage := false -}}
  {{- if not $finalUrl -}}
    {{- with site.Data.placeholder_images -}}
      {{- if and .enabled .images -}}
        {{- $hash := md5 (printf "%s_%s" $context.Title $src) -}}
        {{- $imageIndex := mod (int (substr $hash 0 2 | printf "0x%s")) (len .images) -}}
        {{- $randomImage = index .images $imageIndex -}}
        {{- $useRandomImage = true -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  
  {{/* 统一的占位图生成逻辑 */}}
  {{- $hash := md5 (printf "%s_%s" $context.Title $src) -}}
  {{- $hexColor := substr $hash 0 2 -}}
  {{- $colorIndex := mod (int (printf "0x%s" $hexColor)) 6 -}}
  
  {{- $gradients := slice
    "from-blue-500/20 to-purple-500/10"
    "from-green-500/20 to-teal-500/10"
    "from-orange-500/20 to-red-500/10"
    "from-purple-500/20 to-pink-500/10"
    "from-teal-500/20 to-cyan-500/10"
    "from-rose-500/20 to-orange-500/10"
  -}}
  
  {{- $placeholderData = dict
    "randomImage" $randomImage
    "useRandomImage" $useRandomImage
    "gradients" $gradients
    "colorIndex" $colorIndex
  -}}
{{- end -}}

{{/* 生成响应式图片数据 - 优化性能 */}}
{{- $processedImages := dict -}}
{{- if and $enableResponsive $canProcess $resource -}}
  {{/* 检查图片尺寸，避免不必要的处理 */}}
  {{- $originalWidth := $resource.Width -}}
  {{- if gt $originalWidth 320 -}}
    {{- $dataSizes := "(min-width: 1024px) 960px, (min-width: 768px) 720px, 100vw" -}}
    {{- $actualImg := $resource.Resize (printf "960x q85 %s" $filter) -}}
    
    {{/* 生成WebP格式的srcset - 只处理有意义的尺寸 */}}
    {{- $webpSrcset := slice -}}
    {{- range $size := $respSizes -}}
      {{- $sizeInt := int $size -}}
      {{- if and (ge $originalWidth $sizeInt) (le $sizeInt 1920) -}}
        {{- $resizedImg := $resource.Resize (printf "%sx webp q85 %s %s" $size $hint $filter) -}}
        {{- $webpSrcset = $webpSrcset | append (printf "%s %sw" $resizedImg.RelPermalink $size) -}}
      {{- end -}}
    {{- end -}}
    
    {{/* 生成JPEG格式的srcset - 只处理有意义的尺寸 */}}
    {{- $jpegSrcset := slice -}}
    {{- range $size := $respSizes -}}
      {{- $sizeInt := int $size -}}
      {{- if and (ge $originalWidth $sizeInt) (le $sizeInt 1920) -}}
        {{- $resizedImg := $resource.Resize (printf "%sx jpeg q85 %s" $size $filter) -}}
        {{- $jpegSrcset = $jpegSrcset | append (printf "%s %sw" $resizedImg.RelPermalink $size) -}}
      {{- end -}}
    {{- end -}}
    
    {{- $processedImages = dict
      "actualImg" $actualImg
      "webpSrcset" (delimit $webpSrcset ", ")
      "jpegSrcset" (delimit $jpegSrcset ", ")
      "dataSizes" $dataSizes
      "originalWidth" $originalWidth
    -}}
  {{- end -}}
{{- end -}}

{{/* 将结果设置到上下文中 */}}
{{- $context.Scratch.Set "imageResource" $resource -}}
{{- $context.Scratch.Set "imageUrl" $finalUrl -}}
{{- $context.Scratch.Set "imageType" $resourceType -}}
{{- $context.Scratch.Set "isExternal" $isExternal -}}
{{- $context.Scratch.Set "isModernFormat" $isModernFormat -}}
{{- $context.Scratch.Set "canProcess" $canProcess -}}
{{- $context.Scratch.Set "placeholderData" $placeholderData -}}
{{- $context.Scratch.Set "processedImages" $processedImages -}}

{{/* 根据输出类型生成内容 */}}
{{- if or (eq $outputType "img") (eq $outputType "both") -}}
  {{/* 生成图片HTML */}}
  {{- if $isExternal -}}
    {{/* 外部图像处理 */}}
    <img
      src="{{ $finalUrl }}"
      alt="{{ $alt }}"
      {{ with $caption }}title="{{ . }}"{{ end }}
      {{ if $enableModal }}data-modal="title: {{ $caption | default $alt }}{{ with $alt }}{{ if $caption }}; description: {{ . }}{{ end }}{{ end }}"{{ end }}
      loading="lazy"
      decoding="async" />
  {{- else if $isModernFormat -}}
    {{/* 现代格式处理 (AVIF, HEIC等) - 直接输出 */}}
    <img
      src="{{ $finalUrl }}"
      alt="{{ $alt }}"
      {{ with $caption }}title="{{ . }}"{{ end }}
      {{ if $enableModal }}data-modal="title: {{ $caption | default $alt }}{{ with $alt }}{{ if $caption }}; description: {{ . }}{{ end }}{{ end }}"{{ end }}
      loading="lazy"
      decoding="async" />
  {{- else if and $canProcess $enableResponsive (gt ($context.Scratch.Get "processedImages").originalWidth 0) -}}
    {{/* 内部资源处理 - 支持响应式处理 */}}
    {{- $imgData := $context.Scratch.Get "processedImages" -}}
    <picture>
      {{/* WebP 格式 */}}
      {{- if $imgData.webpSrcset -}}
      <source
        type="image/webp"
        srcset="{{ $imgData.webpSrcset }}"
        sizes="{{ $imgData.dataSizes }}" />
      {{- end -}}

      {{/* JPEG 格式降级 */}}
      {{- if $imgData.jpegSrcset -}}
      <source
        type="image/jpeg"
        srcset="{{ $imgData.jpegSrcset }}"
        sizes="{{ $imgData.dataSizes }}" />
      {{- end -}}

      {{/* 主图像 */}}
      <img
        src="{{ $imgData.actualImg.RelPermalink }}"
        alt="{{ $alt }}"
        {{ with $caption }}title="{{ . }}"{{ end }}
        width="{{ $resource.Width }}"
        height="{{ $resource.Height }}"
        {{ if $enableModal }}data-modal="title: {{ $caption | default $alt }}{{ with $alt }}{{ if $caption }}; description: {{ . }}{{ end }}{{ end }}"{{ end }}
        loading="lazy"
        decoding="async" />
    </picture>
  {{- else if $resource -}}
    {{/* 有资源但不需要响应式处理 */}}
    <img
      src="{{ $finalUrl }}"
      alt="{{ $alt }}"
      {{ with $caption }}title="{{ . }}"{{ end }}
      width="{{ $resource.Width }}"
      height="{{ $resource.Height }}"
      {{ if $enableModal }}data-modal="title: {{ $caption | default $alt }}{{ with $alt }}{{ if $caption }}; description: {{ . }}{{ end }}{{ end }}"{{ end }}
      loading="lazy"
      decoding="async" />
  {{- else -}}
    {{/* 静态文件或其他不支持处理的格式 */}}
    <img
      src="{{ $finalUrl }}"
      alt="{{ $alt }}"
      {{ with $caption }}title="{{ . }}"{{ end }}
      {{ if $enableModal }}data-modal="title: {{ $caption | default $alt }}{{ with $alt }}{{ if $caption }}; description: {{ . }}{{ end }}{{ end }}"{{ end }}
      loading="lazy"
      decoding="async" />
  {{- end -}}
{{- end -}}
{{/*
  相关文章组件

  显示与当前文章相关的其他文章

  @context {page} . 当前文章页面对象
*/}}

{{ $related := .Site.RegularPages.Related . | first 3 }}
{{ $showRelated := .Params.showRelated | default .Site.Params.post.showRelated | default true }}

{{ if and $showRelated $related }}
  <section class="related-posts mb-12">

    <!-- 标题 -->
    <div class="flex items-center gap-3 mb-6">
      {{ partial "icon.html" (dict "name" "related" "size" "md" "ariaLabel" "") }}
      <h2 class="text-2xl font-bold text-foreground">
        {{ i18n "post.related_posts" | default "相关文章" }}
      </h2>
    </div>

    <!-- 相关文章列表 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {{ range $related }}
        <article class="related-post group">
          <a href="{{ .RelPermalink }}" class="block h-full">
            <div class="bg-card border border-border rounded-xl overflow-hidden
                 hover:bg-primary/5 hover:border-primary/20 hover:-translate-y-1 hover:scale-[1.02] hover:shadow-lg
                 transition-all duration-300 ease-out h-full flex flex-col
                 focus:outline-none focus:ring-2 focus:ring-primary/20">

              <!-- 文章封面 -->
              <div class="relative aspect-[16/9] overflow-hidden flex-shrink-0">
                {{ if .Params.cover }}
                  <img
                    src="{{ .Params.cover }}"
                    alt="{{ .Title }}"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy">
                {{ else }}
                  <!-- 动态占位图 (简化版) -->
                  {{ $hash := md5 .Title }}
                  {{ $hexColor := substr $hash 0 2 }}
                  {{ $colorIndex := mod (int (printf "0x%s" $hexColor)) 6 }}

                  {{ $gradients := slice
                    "from-blue-500/20 to-purple-500/10"
                    "from-green-500/20 to-teal-500/10"
                    "from-orange-500/20 to-red-500/10"
                    "from-purple-500/20 to-pink-500/10"
                    "from-teal-500/20 to-cyan-500/10"
                    "from-rose-500/20 to-orange-500/10"
                  }}

                  <div class="w-full h-full bg-gradient-to-br {{ index $gradients $colorIndex }} flex items-center justify-center">
                    <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur-sm border border-white/30 flex items-center justify-center">
                      <span class="text-lg font-bold text-white">{{ substr .Title 0 1 | upper }}</span>
                    </div>
                  </div>
                {{ end }}
              </div>

              <!-- 文章信息 -->
              <div class="p-4 flex flex-col flex-1 min-h-0">

                <!-- 文章标题 -->
                <h3 class="text-base font-semibold text-foreground group-hover:text-primary transition-colors duration-200 line-clamp-2 leading-tight mb-2 flex-shrink-0">
                  {{ .Title }}
                </h3>

                <!-- 文章摘要 -->
                <div class="flex-1 mb-3">
                  {{ if .Summary }}
                    <p class="text-sm text-muted-foreground line-clamp-2 leading-relaxed">
                      {{ .Summary | plainify | truncate 80 }}
                    </p>
                  {{ else }}
                    <p class="text-sm text-muted-foreground/50 italic">
                      {{ i18n "post.no_summary" | default "暂无摘要" }}
                    </p>
                  {{ end }}
                </div>

                <!-- 文章元信息 -->
                <div class="flex items-center justify-between text-xs text-muted-foreground mb-3 flex-shrink-0">

                  <!-- 发布日期 -->
                  <div class="flex items-center gap-1">
                    {{ partial "icon.html" (dict "name" "calendar" "size" "xs" "ariaLabel" "") }}
                    <time datetime="{{ .Date.Format "2006-01-02" }}">
                      {{ .Date.Format "01月02日" }}
                    </time>
                  </div>

                  <!-- 阅读时间 -->
                  {{ if .ReadingTime }}
                    <div class="flex items-center gap-1">
                      {{ partial "icon.html" (dict "name" "clock" "size" "xs" "ariaLabel" "") }}
                      <span>{{ .ReadingTime }}{{ i18n "time.minute" | default "分钟" }}</span>
                    </div>
                  {{ end }}

                </div>

                <!-- 文章标签 -->
                <div class="flex-shrink-0">
                  {{ if .Params.tags }}
                    <div class="flex flex-wrap gap-1">
                      {{ range first 2 .Params.tags }}
                        <span class="inline-flex items-center px-2 py-0.5 rounded bg-muted/50 text-xs text-muted-foreground">
                          #{{ . }}
                        </span>
                      {{ end }}
                      {{ if gt (len .Params.tags) 2 }}
                        <span class="text-xs text-muted-foreground/70">+{{ sub (len .Params.tags) 2 }}</span>
                      {{ end }}
                    </div>
                  {{ else }}
                    <!-- 占位空间，确保高度一致 -->
                    <div class="h-5"></div>
                  {{ end }}
                </div>

              </div>

            </div>
          </a>
        </article>
      {{ end }}
    </div>

    <!-- 查看更多相关文章 -->
    {{ if gt (len $related) 3 }}
      <div class="text-center mt-8">
        <a
          href="{{ "/posts/" | relURL }}"
          class="inline-flex items-center gap-2 px-4 py-2 text-primary
          hover:text-primary/80 hover:-translate-y-0.5 hover:scale-105
          transition-all duration-200 ease-out font-medium
          focus:outline-none focus:ring-2 focus:ring-primary/20 rounded-lg">
          <span>{{ i18n "post.view_more_posts" | default "查看更多文章" }}</span>
          {{ partial "icon.html" (dict "name" "arrow-right" "size" "sm" "ariaLabel" "") }}
        </a>
      </div>
    {{ end }}

  </section>
{{ end }}

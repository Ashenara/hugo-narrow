---
title: '裸核使用方法'
date: 2025-05-12T21:22:42+08:00
draft: true
slug: 5ae84b1
description: Windows 裸核使用方法。
summary: Windows 裸核使用方法。
tags:
  - Windows
categories:
  - 实用教程
cover:
---

## 前言

最近一些 GUI 客户端出现了一些漏洞，并且时不时有一些 BUG，而其他工具无法很好地分流，所以决定使用裸核，在[一篇博客](https://senzyo.net/2023-7/)找到了方法，对其脚本就行了一些修改。

## 步骤

### 核心下载

直接下载二进制文件，解压后无需重命名，新建一个文件夹放入。

### 配置文件

创建一个 `config.yaml` 文件，写入配置文件，放入核心同级目录下。参考配置如下，更换订阅链接(第 3 行)以及外部 `API` 控制密钥(第 50 行)。

```yaml
proxy-providers: 
  ZJ:
    url: '订阅链接'
    path: './proxy-providers/ZJ.yaml'
    type: http
    interval: 86400
    health-check: 
      enable: true
      lazy: true
      url: http://latency-test.skk.moe/endpoint
      interval: 60



port: 7891
socks-port: 7892
mixed-port: 7890

redir-port: 7893
tproxy-port: 7894

unified-delay: true
tcp-concurrent: true
allow-lan: true
mode: rule
log-level: info
ipv6: true
udp: true

profile:
  store-selected: true
  store-fake-ip: true

find-process-mode: strict
global-client-fingerprint: chrome

geodata-mode: true
geodata-loader: standard
geo-auto-update: true
geo-update-interval: 24
geox-url:
  geoip: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat
  geosite: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat
  mmdb: https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb
  asn: https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb



external-controller: 127.0.0.1:9090
secret: "自己设定一个密码"

external-ui: ui
external-ui-name: zashboard
external-ui-url: https://github.com/Zephyruso/zashboard/releases/latest/download/dist.zip
# external-ui-name: MetaCubeXD
# external-ui-url: https://github.com/MetaCubeX/metacubexd/archive/refs/heads/gh-pages.zip


sniffer:
  enable: true
  force-dns-mapping: true
  parse-pure-ip: true
  override-destination: true
  sniff:
    HTTP:
      ports: [80, 8080-8880]
      override-destination: true
    TLS:
      ports: [443, 8443]
    QUIC:
      ports: [443, 8443]
  force-domain:
    - +.v2ex.com

  skip-domain:
    - Mijia Cloud
    - +.push.apple.com
  skip-src-address:
    - 192.168.1.1/24
  skip-dst-address:
    - 91.105.192.0/23
    - 91.108.4.0/22
    - 91.108.8.0/21
    - 91.108.16.0/21
    - 91.108.56.0/22
    - 95.161.64.0/20
    - 149.154.160.0/20
    - 185.76.151.0/24
    - 2001:67c:4e8::/48
    - 2001:b28:f23c::/47
    - 2001:b28:f23f::/48
    - 2a0a:f280:203::/48
tun:
  enable: false
  stack: mixed
  device: utun0
  dns-hijack:
    - any:53
    - tcp://any:53
  auto-route: true
  auto-detect-interface: true
  strict-route: true

dns:
  enable: true
  listen: 0.0.0.0:1053
  ipv6: true
  prefer-h3: true
  use-hosts: true
  use-system-hosts: true
  respect-rules: true
  enhanced-mode: fake-ip
  fake-ip-range: 28.0.0.1/8
  fake-ip-filter:
    - "*"
    - "+.lan"
    - "+.local"
    - "time.*.com"
    - "ntp.*.com"
    - "+.market.xiaomi.com"
  default-nameserver:
    - 223.5.5.5
    - 119.29.29.29
  nameserver:
    - https://120.53.53.53/dns-query#h3=true
    - https://223.6.6.6/dns-query#h3=true
    - https://223.5.5.5/dns-query#h3=true
  proxy-server-nameserver:
    - https://120.53.53.53/dns-query
    - https://223.5.5.5/dns-query




FilterHK: &FilterHK '🇭🇰'
FilterJP: &FilterJP '🇯🇵'
FilterSG: &FilterSG '🇸🇬'
FilterUS: &FilterUS '🇺🇸'
FilterOther: &FilterOther '^((?!(🇭🇰|🇸🇬|🇺🇸|🇯🇵|港|美|日|坡|狮|广告|剩余|官网|到期|流量|HK|US|JP|SG|Hong|Singapore|Japan|United)).)*$'
FilterAll: &FilterAll '^(?=.*(.))(?!.*((?i)群|邀请|返利|循环|官网|客服|网站|网址|获取|订阅|流量|到期|机场|下次|版本|官址|备用|过期|已用|联系|邮箱|工单|贩卖|通知|倒卖|防止|国内|地址|频道|无法|说明|使用|提示|特别|访问|支持|教程|关注|更新|作者|加入|(\b(USE|USED|TOTAL|EXPIRE|EMAIL|Panel|Channel|Author)\b|(\d{4}-\d{2}-\d{2}|\d+G)))).*$'



Select: &Select {type: select, disable-udp: false, hidden: false, include-all: true}
UrlTest: &UrlTest {type: url-test, interval: 6, tolerance: 20, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}
FallBack: &FallBack {type: fallback, interval: 6, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}
LoadBalance: &LoadBalance {type: load-balance, interval: 6, lazy: true, url: 'http://latency-test.skk.moe/endpoint', disable-udp: false, strategy: consistent-hashing, timeout: 2000, max-failed-times: 3, hidden: false, include-all: true}


Classical: &Classical {type: http, behavior: classical, interval: 86400}
Domain: &Domain {type: http, behavior: domain, interval: 86400}
IP: &IP {type: http, behavior: ipcidr, interval: 86400}


proxy-groups: 
  - {name: Proxy, <<: *FallBack, filter: *FilterAll, icon: https://raw.githubusercontent.com/Koolson/Qure/master/IconSet/Color/Proxy.png}
  - {name: AIGC, <<: *FallBack, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/OpenAI.png}
  - {name: Emby, <<: *Select, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Emby.png}
  - {name: Netflix, <<: *Select, filter: *FilterSG, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Netflix.png}
  - {name: Spotify, <<: *Select, proxies: [DIRECT], icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/Spotify.png}  

# 地区策略 
#  - {name: Hong Kong, <<: *FallBack, filter: *FilterHK, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/HK.png}
#  - {name: Singapore, <<: *FallBack, filter: *FilterSG, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/SG.png}
#  - {name: United States, <<: *FallBack, filter: *FilterUS, icon: https://raw.githubusercontent.com/Orz-3/mini/master/Color/US.png}




rule-providers:
  applications: { <<: *Classical, format: yaml, path: ./rule-providers/applications.txt, url: https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/applications.txt }
  awavenue_ad_rule: { <<: *Domain, format: yaml, path: ./rule-providers/awavenue_ad_rule.yaml, url: https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml }
  reject_non_ip_drop: { <<: *Classical, format: text, path: ./rule-providers/reject_non_ip_drop.txt, url: https://ruleset.skk.moe/Clash/non_ip/reject-drop.txt }
  reject_non_ip: { <<: *Classical, format: text, path: ./rule-providers/reject_non_ip.txt, url: https://ruleset.skk.moe/Clash/non_ip/reject.txt }
  reject_domainset: { <<: *Domain, format: text, path: ./rule-providers/reject_domainset.txt, url: https://ruleset.skk.moe/Clash/domainset/reject.txt }
  private_domain: { <<: *Domain, format: mrs, path: ./rule-providers/private_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/private.mrs }
  steam@cn: { <<: *Domain, format: mrs, path: ./rule-providers/steam@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/steam@cn.mrs }
  category-games@cn: { <<: *Domain, format: mrs, path: ./rule-providers/category-games@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/category-games@cn.mrs }
  apple-cn: { <<: *Domain, format: mrs, path: ./rule-providers/apple-cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/apple-cn.mrs }
  apple@cn: { <<: *Domain, format: mrs, path: ./rule-providers/apple@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/apple@cn.mrs }
  icloud: { <<: *Domain, format: mrs, path: ./rule-providers/icloud.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/icloud.mrs }
  microsoft@cn: { <<: *Domain, format: mrs, path: ./rule-providers/microsoft@cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/microsoft@cn.mrs }
  onedrive: { <<: *Domain, format: mrs, path: ./rule-providers/onedrive.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/onedrive.mrs }
  microsoft: { <<: *Domain, format: mrs, path: ./rule-providers/microsoft.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/microsoft.mrs }
  telegram_domain: { <<: *Domain, format: mrs, path: ./rule-providers/telegram_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/telegram.mrs }
  spotify: { <<: *Domain, format: mrs, path: ./rule-providers/spotify.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/spotify.mrs }
  netflix_domain: { <<: *Domain, format: mrs, path: ./rule-providers/netflix_domain.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/netflix.mrs }
  category-ai-chat-!cn: { <<: *Domain, format: mrs, path: ./rule-providers/category-ai-chat-!cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/category-ai-chat-!cn.mrs }
  emby: { <<: *Classical, format: text, path: ./rule-providers/emby.list, url: https://raw.githubusercontent.com/tom2almighty/files/main/Surge/Rules/Emby.list }
  geolocation-!cn: { <<: *Domain, format: mrs, path: ./rule-providers/geolocation-!cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/geolocation-!cn.mrs }
  cn: { <<: *Domain, format: mrs, path: ./rule-providers/cn.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geosite/cn.mrs }
  reject_ip: { <<: *IP, format: text, path: ./rule-providers/reject_ip.txt, url: https://ruleset.skk.moe/Clash/ip/reject.txt }
  private_ip: { <<: *IP, format: mrs, path: ./rule-providers/private_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/private.mrs }
  telegram_ip: { <<: *IP, format: mrs, path: ./rule-providers/telegram_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/telegram.mrs }
  netflix_ip: { <<: *IP, format: mrs, path: ./rule-providers/netflix_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/netflix.mrs }
  cn_ip: { <<: *IP, format: mrs, path: ./rule-providers/cn_ip.mrs, url: https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/refs/heads/meta/geo/geoip/cn.mrs }





rules:
  - AND,((DST-PORT,123),(NETWORK,UDP)),DIRECT
  - RULE-SET,applications,DIRECT
  - AND,((NETWORK,UDP),(DOMAIN-SUFFIX,googlevideo.com)),REJECT
  - RULE-SET,awavenue_ad_rule,REJECT
  - RULE-SET,reject_non_ip_drop,REJECT-DROP
  - RULE-SET,reject_non_ip,REJECT
  - RULE-SET,reject_domainset,REJECT

  - RULE-SET,private_domain,DIRECT
  - RULE-SET,steam@cn,DIRECT
  - RULE-SET,category-games@cn,DIRECT
  - RULE-SET,apple-cn,DIRECT
  - RULE-SET,apple@cn,DIRECT
  - RULE-SET,icloud,DIRECT
  - RULE-SET,microsoft@cn,DIRECT

  - DOMAIN-SUFFIX,onedrive.live.com,Proxy
  - RULE-SET,onedrive,DIRECT
  - RULE-SET,microsoft,Proxy
  - RULE-SET,telegram_domain,Proxy
  - RULE-SET,spotify,Spotify
  - RULE-SET,netflix_domain,Netflix
  - RULE-SET,category-ai-chat-!cn,AIGC
  - RULE-SET,emby,Emby
  - RULE-SET,geolocation-!cn,Proxy
  - DOMAIN-SUFFIX,grew.cc,Proxy
  
  - RULE-SET,cn,DIRECT
  - DOMAIN-SUFFIX,cn,DIRECT
  
  - RULE-SET,reject_ip,REJECT
  - RULE-SET,private_ip,DIRECT,no-resolve
  - RULE-SET,telegram_ip,Proxy,no-resolve
  - RULE-SET,netflix_ip,Netflix,no-resolve
  - RULE-SET,cn_ip,DIRECT,no-resolve

  - MATCH,Proxy
```

配置中可简化 `rule-providers` 部分为 `GEOSITE` 及 `GEOIP`。

### 核心开机自启

下载好核心后可以配置开机自启服务。

打开任务计划程序, 点击右侧操作列表中的“创建任务”:

1. 常规

   名称填 `mihomo`。 `更改用户或组`， 输入 `system`，点击 `检查名称` 按钮， 变为 SYSTEM，即使用 `SYSTEM` 账户。

2. 触发器

   新建，`开始任务` 选择 `登录时` 或 `启动时`， 按需选择 `延迟任务时间`， 确认勾选 `已启用`。

3. 操作

   新建，`操作` 选择 `启动程序`；`程序或脚本` 填写 `mihomo.exe`； `添加参数` 填写 `-d .\ -f config.yaml`； `起始于` 填写 `mihomo` 工作目录，即二进制文件所在目录，比如 `D:\Program\mihomo`。

   常用参数如下，可自己搭配：
   ```bash
     -config string
           specify base64-encoded configuration string
     -d string
           set configuration directory
     -ext-ctl string
           override external controller address
     -ext-ctl-pipe string
           override external controller pipe address
     -ext-ctl-unix string
           override external controller unix address
     -ext-ui string
           override external ui directory
     -f string
           specify configuration file
     -m    set geodata mode
     -secret string
           override secret for RESTful API
     -t    test configuration and exit
     -v    show current version of mihomo
   ```

4. 条件

   全部取消勾选，包括灰显的。

5. 设置

   1. 仅勾选 `允许按需运行任务`。
   2. 最下方的 `如果此任务已经运行, 以下规则适用`, 确认选择 `请勿启动新实例`。

### 脚本文件

上述参考配置中， `TUN Mode` 默认是关闭的，因此需要开启系统代理使用。

#### 脚本使用步骤

1. 将脚本文件放在二进制文件所在目录，后缀填写 `.ps1`。

2. 右击脚本文件，发送的桌面快捷方式。
3. 右击桌面快捷方式，在 `目标` 前填写 `powershell.exe" -ExecutionPolicy Bypass -File `，如果安装了新版 `powershell`，则换成 `pwsh.exe`。最终如：`powershell.exe -ExecutionPolicy Bypass -File "Stop.ps1"`
4. 同样桌面快捷方式，选择 `高级`，勾选 `用管理员方式运行`。
5. 确认后运行即可。


> [!TIP]
>
> 下面的各个脚本文件中，需要注意相关参数和名称和自己的配置匹配：
>
> - `$controller_api`：配置文件外部控制 API 地址
> - `$api_secret`：配置文件外部控制 API 密钥
> - `$task`：任务计划程序名称
> - `$proxy_port`：配置文件代理端口



#### 启动系统代理

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# 配置参数
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"
$proxy_port = 7890

# 函数：弹窗通知
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "系统代理模式已启用",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. 检查并启动内核
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "❌ 启动内核失败" -ForegroundColor Red
            exit 1
        }
    }

    # 2. 启用系统代理
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 1
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value "127.0.0.1:$proxy_port"
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>"
    
    # 立即生效代理设置
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. 禁用TUN模式
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": false}}' `
        -Uri "$controller_api/configs"

    # 成功反馈
    Write-Host "✅ 系统代理已启用 (端口 $proxy_port)" -ForegroundColor Green
    Write-Host "✅ TUN模式已禁用" -ForegroundColor Green
    Show-Notification "系统代理已启用`n端口: $proxy_port`nTUN模式已关闭"
}
catch {
    Write-Host "❌ 操作失败: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### 关闭系统代理

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# 函数：弹窗通知
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "系统代理设置",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. 禁用系统代理注册表设置
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' `
        -Name ProxyEnable `
        -Value 0 `
        -ErrorAction Stop

    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' `
        -Name ProxyServer `
        -Value "" `
        -ErrorAction Stop

    # 2. 立即生效代理设置
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. 反馈结果
    Write-Host "✅ 系统代理已关闭" -ForegroundColor Green
    Show-Notification "系统代理已成功关闭"
}
catch {
    Write-Host "❌ 关闭代理失败: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### 启动核心-系统代理

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# 配置参数
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"
$proxy_port = 7890

# 函数：弹窗通知
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "系统代理模式已启用",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. 检查并启动内核
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "❌ 启动内核失败" -ForegroundColor Red
            exit 1
        }
    }

    # 2. 启用系统代理
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 1
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value "127.0.0.1:$proxy_port"
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>"
    
    # 立即生效代理设置
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. 禁用TUN模式
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": false}}' `
        -Uri "$controller_api/configs"

    # 成功反馈
    Write-Host "✅ 系统代理已启用 (端口 $proxy_port)" -ForegroundColor Green
    Write-Host "✅ TUN模式已禁用" -ForegroundColor Green
    Show-Notification "系统代理已启用`n端口: $proxy_port`nTUN模式已关闭"
}
catch {
    Write-Host "❌ 操作失败: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### 启动核心-TUN

```powershell
$ErrorActionPreference = 'SilentlyContinue'

# 配置参数
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$task = "mihomo"

# 函数：弹窗通知
function Show-Notification {
    param($message)
    Add-Type -AssemblyName System.Windows.Forms
    [System.Windows.Forms.MessageBox]::Show(
        $message,
        "TUN模式已启用",
        [System.Windows.Forms.MessageBoxButtons]::OK,
        [System.Windows.Forms.MessageBoxIcon]::Information
    )
}

try {
    # 1. 检查并启动内核
    $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
    if ($state -ne "Running") {
        Start-ScheduledTask -TaskName $task
        Start-Sleep -Seconds 3
        $state = Get-ScheduledTask -TaskName $task | Select-Object -ExpandProperty State
        if ($state -ne "Running") {
            Write-Host "❌ 启动内核失败" -ForegroundColor Red
            exit 1
        }
    }

    # 2. 关闭系统代理
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 0
    Set-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyServer -Value ""
    
    # 立即生效代理设置
    rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0
    rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0

    # 3. 启用TUN模式
    $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
        -ContentType "application/json" `
        -Method PATCH `
        -Body '{"tun": {"enable": true}}' `
        -Uri "$controller_api/configs"

    # 成功反馈
    Write-Host "✅ 系统代理已关闭" -ForegroundColor Green
    Write-Host "✅ TUN模式已启用" -ForegroundColor Green
    Show-Notification "系统代理已关闭`nTUN模式已启用"
}
catch {
    Write-Host "❌ 操作失败: $($_.Exception.Message)" -ForegroundColor Red
    exit 1
}
```

#### 切换模式

```powershell
$ErrorActionPreference = 'Stop'

# 配置参数
$controller_api = "http://127.0.0.1:9090"
$api_secret = ""
$proxy_port = 7890
$registryPath = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Internet Settings'

# 函数：统一注册表操作
function Update-ProxySettings {
    param(
        [bool]$enable,
        [string]$proxyServer = ""
    )
    try {
        Set-ItemProperty -Path $registryPath -Name ProxyEnable -Value ([int]$enable) -ErrorAction Stop
        Set-ItemProperty -Path $registryPath -Name ProxyServer -Value $proxyServer -ErrorAction Stop
        if ($enable) {
            Set-ItemProperty -Path $registryPath -Name ProxyOverride -Value "localhost;127.*;10.*;172.16.*;172.17.*;172.18.*;172.19.*;172.20.*;172.21.*;172.22.*;172.23.*;172.24.*;172.25.*;172.26.*;172.27.*;172.28.*;172.29.*;172.30.*;172.31.*;192.168.*;<local>" -ErrorAction Stop
        }
        
        # 双刷新机制确保立即生效
        rundll32.exe wininet.dll,InternetSetOptionA 0 39 0 0 | Out-Null
        rundll32.exe wininet.dll,InternetSetOptionA 0 37 0 0 | Out-Null
    }
    catch {
        Write-Host "❌ 代理设置失败: $($_.Exception.Message)" -ForegroundColor Red
        throw
    }
}

# 函数：增强API调用（含重试逻辑）
function Update-TunMode {
    param([bool]$enable)
    try {
        $body = @{ tun = @{ enable = $enable } } | ConvertTo-Json -Compress
        $null = Invoke-RestMethod -Headers @{ "Authorization" = "Bearer $api_secret" } `
            -ContentType "application/json" `
            -Method PATCH `
            -Body $body `
            -Uri "$controller_api/configs" `
            -ErrorAction Stop `
            -TimeoutSec 3  # 添加超时限制
        
        Write-Host "TUN模式已切换: $(if ($enable) {'启用'} else {'关闭'})" -ForegroundColor DarkGray
    }
    catch {
        Write-Host "❌ TUN模式切换失败: $($_.Exception.Message)" -ForegroundColor Red
        throw
    }
}

# 函数：增强型通知
function Show-SwitchStatus {
    param($proxyStatus, $tunStatus)
    Add-Type -AssemblyName System.Windows.Forms
    $icon = [System.Windows.Forms.MessageBoxIcon]::Information
    $title = "代理模式切换"
    
    # 控制台颜色反馈
    Write-Host "`n当前状态：" -ForegroundColor Cyan
    Write-Host "• 系统代理: $proxyStatus" -ForegroundColor $(if ($proxyStatus -eq "启用") { "Green" } else { "Yellow" })
    Write-Host "• TUN模式:  $tunStatus`n" -ForegroundColor $(if ($tunStatus -eq "启用") { "Green" } else { "Yellow" })
    
    # 弹窗通知
    [System.Windows.Forms.MessageBox]::Show(
        "系统代理: $proxyStatus`nTUN模式: $tunStatus",
        $title,
        [System.Windows.Forms.MessageBoxButtons]::OK,
        $icon
    )
    
    # 系统提示音
    [System.Media.SystemSounds]::Exclamation.Play()
}

try {
    # 获取当前代理状态
    $currentProxy = [bool](Get-ItemPropertyValue -Path $registryPath -Name ProxyEnable -ErrorAction Stop)

    # 核心切换逻辑
    if ($currentProxy) {
        Update-ProxySettings -enable $false
        Update-TunMode -enable $true
        Show-SwitchStatus -proxyStatus "关闭" -tunStatus "启用"
    }
    else {
        Update-ProxySettings -enable $true -proxyServer "127.0.0.1:$proxy_port"
        Update-TunMode -enable $false
        Show-SwitchStatus -proxyStatus "启用" -tunStatus "关闭"
    }
}
catch {
    Write-Host "`n❌ 切换失败: $($_.Exception.Message)" -ForegroundColor Red
    [System.Media.SystemSounds]::Hand.Play()
    exit 1
}
```

#### 停止核心并关闭系统代理

```powershell
$process = "mihomo-windows-amd64"

Set-ItemProperty -Path 'Registry::HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Internet Settings' -Name ProxyEnable -Value 0
Write-Host "System proxy disabled."
Stop-Process -Name $process -Force > $null 2>&1
Write-Host "${process} stopped."
Clear-DnsClientCache
Start-Sleep -Seconds 1
```

### UWP应用

对于不走系统代理的应用，可以使用 `Windows 8 AppContainer Loopback Utility`，地址和下载链接如下：

- [地址](https://www.telerik.com/fiddler/add-ons)
- [下载地址](https://telerik-fiddler.s3.amazonaws.com/fiddler/addons/enableloopbackutility.exe)

### WebUI

对于切换节点可以使用 `WebUI`，配置文件中指定下载链接后可以通过下面的链接打开，更换自己的密钥：

```bash
http://127.0.0.1:9090/#/setup?hostname=127.0.0.1&port=9090&secret=123456
```

推荐两个控制面板：

- [ZashBoard](https://github.com/Zephyruso/zashboard)
- [MetaCubeXD](https://github.com/MetaCubeX/metacubexd)

## 参考

- [Clash on Windows](https://senzyo.net/2023-7)

